<!-- <link rel="import" href="../polymer/polymer-element.html"> -->
<link rel="import" href="./bower_components/polymer/polymer-element.html">

<dom-module id="saiku-embed">
  <template>
    <!-- Scoped CSS for this element -->
    <style>
      :host {
        display: block;
        width: 100%;
      }
    </style>
    <div>
      <!-- Any children are rendered here -->
      <slot></slot>
      <iframe allowtransparency="true" frameborder="0" scrolling="auto"></iframe>
    </div>
  </template>

  <script>
    /**
     * `saiku-embed`
     * A web component to embed Saiku Analytics
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class SaikuEmbed extends Polymer.Element {
      constructor() {
        super();

        this.attachShadow({
          mode: 'open'
        }).innerHTML = SaikuEmbed.template.innerHTML;

        if (!this.url) {
          this.textContent = `The url attribute is not included.
            Go to https://github.com/OSBI/saiku-embed-element#saiku-embed-element
            and see the documentation.`;
        }
      }

      static get is() {
        return 'saiku-embed';
      }

      static get properties() {
        return {
          url: String,
          username: String,
          password: String,
          width: { type: String, value: '800' },
          height: { type: String, value: '600' },
          schema: String,
          cube: String,
          splash: { type: Boolean, value: true },
          plugin: { type: Boolean, value: false }
        };
      }

      static get observedAttributes() {
        return [
          'url',
          'username',
          'password',
          'width',
          'height',
          'schema',
          'cube',
          'splash',
          'plugin'
        ];
      }

      connectedCallback() {
        const iframe = this.shadowRoot.querySelector('iframe');
        iframe.width = this.width;
        iframe.height = this.height;
        iframe.src = this.getInlineFrameSource();
      }

      attributeChangedCallback(attributeName, oldValue, newValue) {
        const iframe = this.shadowRoot.querySelector('iframe');

        switch (attributeName) {
          case 'width':
          case 'height':
            this[attributeName] = newValue;
            break;
          case 'splash':
          case 'plugin':
            this[attributeName] = this._isAttributeTrueFromMarkup(newValue);
            break;
          default:
            iframe.src = this.getInlineFrameSource();
            break;
        }
      }

      get url() {
        return this.getAttribute('url');
      }

      set url(newValue) {
        if (this.url !== newValue) {
          this.setAttribute('url', newValue);
        }
      }

      get username() {
        return this.getAttribute('username');
      }

      set username(newValue) {
        if (this.username !== newValue) {
          this.setAttribute('username', newValue);
        }
      }

      get password() {
        return this.getAttribute('password');
      }

      set password(newValue) {
        if (this.password !== newValue) {
          this.setAttribute('password', newValue);
        }
      }

      get width() {
        return this.getAttribute('width');
      }

      set width(newValue) {
        if (this.width !== newValue) {
          this.setAttribute('width', newValue);
        }
      }

      get height() {
        return this.getAttribute('height');
      }

      set height(newValue) {
        if (this.height !== newValue) {
          this.setAttribute('height', newValue);
        }
      }

      get schema() {
        return this.getAttribute('schema');
      }

      set schema(newValue) {
        if (this.schema !== newValue) {
          this.setAttribute('schema', newValue);
        }
      }

      get cube() {
        return this.getAttribute('cube');
      }

      set cube(newValue) {
        if (this.cube !== newValue) {
          this.setAttribute('cube', newValue);
        }
      }

      get splash() {
        return this.getAttribute('splash');
      }

      set splash(newValue) {
        if (this.splash !== newValue.toString()) {
          this.setAttribute('splash', newValue);
        }
      }

      get plugin() {
        return this.getAttribute('plugin');
      }

      set plugin(newValue) {
        if (this.plugin !== newValue.toString()) {
          this.setAttribute('plugin', newValue);
        }
      }

      getInlineFrameSource() {
        const params = this._getAttributesParams();
        const src = this._requestUrl(this.url, params);

        return window.decodeURIComponent(src);
      }

      _isAttributeTrueFromMarkup(obj) {
        return obj === true ||
               obj === 'true' ||
               obj === '' ||
               obj.length === 0 ||
               toString.call(obj) === '[object Boolean]';
      }

      _getAttributesParams() {
        let params = {};
        let attrName;

        for (let i = 0; i < this.attributes.length; i++) {
          if (SaikuEmbed.properties.hasOwnProperty(this.attributes[i].name) &&
              (this.attributes[i].name !== 'url' &&
               this.attributes[i].name !== 'width' &&
               this.attributes[i].name !== 'height')) {

            attrName = this.attributes[i].name;
            params[attrName] = this.attributes[i].value;
          }
        }

        return params;
      }

      _queryString(params) {
        const queryParts = [];
        let param;
        let value;

        for (param in params) {
          value = params[param];
          param = window.encodeURIComponent(param);

          if (Array.isArray(value)) {
            for (let i = 0; i < value.length; i++) {
              queryParts.push(`${param}=${window.encodeURIComponent(value[i])}`);
            }
          }
          else if (value !== null) {
            queryParts.push(`${param}=${window.encodeURIComponent(value)}`);
          }
          else {
            queryParts.push(param);
          }
        }

        return queryParts.join('&');
      }

      _requestUrl(url, params) {
        const queryString = this._queryString(params);
        const newUrl = url || '';

        if (queryString) {
          const bindingChar = newUrl.indexOf('?') >= 0 ? '&' : '?';

          return newUrl + bindingChar + queryString;
        }

        return newUrl;
      }
    }

    window.customElements.define(SaikuEmbed.is, SaikuEmbed);
  </script>
</dom-module>
